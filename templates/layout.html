<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


    <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script> -->

    <link href="/static/styles.css" rel="stylesheet">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:ital,wght@0,300..900;1,300..900&display=swap" rel="stylesheet">

    <title>Wisp: {% block title %}{% endblock %}</title>
    
</head>

<body>
    <!-- Header -->
    {% if session["user_id"] %} 
    <div class="header flex-center">
    {% else %}
    <div class="header login-header flex-center"> 
    {% endif %}  
    {% block header %}{% endblock %}  
    </div>

    <!-- Main -->
    <div class="main">

        <div class="welcome">
        {% block welcome %}{% endblock %}
        </div>
        
        <div id="flashed-messages-container"></div>
        <div class="section-container">
            {% block main %}
                {% block sidebar %}
                {% endblock %}
                {% block main_content %}
                {% endblock %}
            {% endblock %}
        </div>

        <!-- Footer -->
        <footer>
            <p>Wisp by Evan Hedgecock</p>
        </footer>
    </div>
    
    
    

    <script>
        function dropDown() {
            document.getElementById("profile-dropdown").classList.toggle("show");
            document.getElementById("profile-button").classList.toggle("ignore");
            }
        
        function toggleSidebar() {
            document.getElementById('s-m').classList.toggle('visible');
            document.getElementById('s-m').classList.toggle('collapse');
            }
    
        function openAddForm() {
            document.getElementById('add-loan-form-container').classList.toggle('visible');
            document.getElementById('add-loan-form-container').classList.toggle('collapse');
            toggleSidebar()

            }

        function openEditForm() {
            document.getElementById('edit-loan-form-container').classList.toggle('visible');
            document.getElementById('edit-loan-form-container').classList.toggle('collapse');
            toggleSidebar()
        }

        function openPaymentForm() {
            document.getElementById('make-payment-form-container').classList.toggle('visible');
            document.getElementById('make-payment-form-container').classList.toggle('collapse');
            toggleSidebar()
        }

        function goBack(openForm) {
            openForm
        }
        
        function onlyNumberKey(evt) {
            // Only ASCII character in that range allowed
            var ASCIICode = (evt.which) ? evt.which : evt.keyCode
            console.log(ASCIICode)
            if ((ASCIICode <= 57 && ASCIICode >= 48) || ASCIICode == 46) {
                return true;
            }
            else {
                return false;
            }
        }

        function formatToUSD(value) {
            let number = parseFloat(value);
            if (isNaN(number)) {
                return "";
            }
            // Format number with commas and two decimal places
            return "$" + number.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function formatToPercentage(value) {
            let number = parseFloat(value);
            if (isNaN(number)) {
                return "";
            }
            // Format number to two decimal places with percent sign
            return number.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + "%";
        }

        function formatInput(event) {
            const input = event.target;
            const value = input.value.replace(/,/g, ''); // Remove commas for proper formatting
            const formatType = input.dataset.format; // Determine format type using data attribute

            let formattedValue;
            if (formatType === "usd") {
                formattedValue = formatToUSD(value);
            } else if (formatType === "percentage") {
                formattedValue = formatToPercentage(value);
            }

            // Find the corresponding <span> element to update
            const formattedSpan = input.nextElementSibling;
            formattedSpan.innerText = formattedValue;
        }
        
        function displayFlashedMessages(messages, formName) {
            console.log("When flashed, formName =", formName);
            
            const container = document.getElementById("flashed-messages-container");
            messages.forEach(([category, message]) => {
                console.log("Message: " + message + "\n" + "Category: " + category);
                
                const messageElement = document.createElement("div");
                messageElement.className = `flashes ${category}`;
                messageElement.innerText = message;
                container.appendChild(messageElement);

                // Position the message relative to the form
                const form = document.getElementById(formName);
                form.parentNode.insertBefore(container, form); // Insert the container before the form
                console.log("Form name: " + formName)
                const formRect = form.getBoundingClientRect();
                console.log(formRect);
                console.log("formRect width: " + (formRect.width / 2) )
                
                messageElement.style.bottom = formRect.top + 'px';
                messageElement.style.left = formRect.left + 'px'; 
                messageElement.style.width = formRect.width + 'px';
                console.log("messageElement width: " + messageElement.getBoundingClientRect().width)
            });
        }

        // Check for flashed messages and form name
        document.addEventListener("DOMContentLoaded", () => {
            const flashedMessages = {{ get_flashed_messages(with_categories=True) | tojson }};
            const formName = "{{ session.pop('form_name', '') }}"
            console.log("Checking for flashes from:", formName);
            
            if (flashedMessages.length > 0 && formName) {
                console.log("Displaying flashed message:", flashedMessages, "\nFor formName:", formName);
                
                displayFlashedMessages(flashedMessages, formName);
            }
        });

        function setSelectedOptionId(dropdown_id) {
            var dropdown = document.getElementById(dropdown_id);
            console.log("dropdown:", dropDown);
            
            var selectedOption = dropdown.options[dropdown.selectedIndex];
            console.log("selected option:", selectedOption);
            
            var hiddenInput = document.getElementById("selected-option-id");
            console.log("hidden input:", hiddenInput);
            
            hiddenInput.value = selectedOption.id;
            console.log("hidden value:", hiddenInput.value);
            
        }

    </script>
</body>

</html>